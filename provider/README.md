# 通道集成指南

本文档旨在为开发者提供一个关于主流消息推送通道的全面指南，帮助你将各类应用和服务的通知高效、安全地集成到团队的日常工作流中。

我们将深入探讨以下几种通道的集成方式：

* **企业通讯工具机器人**：利用企业微信、飞书、钉钉和 Slack 的机器人，将自动化消息无缝嵌入团队沟通。
* **通用 Webhook**：通过标准化的 HTTP 回调机制，实现与任何支持 Webhook 的应用进行对接。

在每个通道的章节中，你将了解到：

* **创建与配置**：从零开始设置机器人或 Webhook 的详细步骤。
* **消息格式详解**：json 数据结构与示例。
* **核心安全机制**：包括签名校验、IP 白名单等，确保通信安全可靠。

无论你需要发送哪种消息，本文档都将为你提供清晰的指引和实践示例。

1. **企业微信群机器人**
2. **飞书自定义机器人**
3. **钉钉自定义机器人**
4. **Slack 机器人**
5. **[Webhook](webhook.md)**

## 配置 (`config.toml`)

说明`PostPoint`配置文件的详细定义

### `provider.xxx` - 通用通道配置

本部分定义了通道配置的详细参数，以飞书自定义机器人为例。

```toml
# 飞书自定义机器人 配置段
[provider.feishu_bot]

# [必填] Webhook 服务器地址
# 这是在飞书群组中添加自定义机器人后生成的唯一 URL。所有通过该通道发送的消息都将 POST 到此地址。
# 出于安全考虑，请妥善保管此 Webhook 地址，避免泄露。
endpoint.url = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxx"

# [可选] 签名密钥
# 用于请求签名，以验证消息来源的可靠性，防止 Webhook 地址泄露后被恶意调用。
# 在飞书机器人安全设置中选择“签名校验”后，飞书会提供一个密钥。
# 启用后，系统会使用此密钥和时间戳通过 HMAC-SHA256 算法生成签名，并附加到请求中。
secret = "xxx"

# [可选] 速率限制：每分钟
# 根据飞书官方文档，单个自定义机器人的消息发送频率上限为 100次/分钟。
# 此处设置为 98 是一个保守策略，旨在避免精确达到限制阈值而导致消息发送失败。
# 'burst' 代表一分钟内允许发送的最大消息数量。
rate_limit.minute.burst = 98

# [可选] 速率限制：每秒
# 根据飞书官方文档，单个自定义机器人的消息发送频率上限为 5次/秒。
# 此处设置为 4 是一个保守策略，以防止触发限流。
# 'frequency' 代表一秒内允许发送的最大消息数量。
rate_limit.rate.frequency = 4

# [可选] 通道代理
# 用于在特定网络环境下（例如，服务器无法直接访问公网）通过代理服务器发送请求。
# - 如果留空或未配置，将使用全局代理（如果已设置）。
# - 如果配置了代理 URL，则此通道将优先使用自己的代理。
# - 如果想明确指定不使用任何代理（即使已设置全局代理），请配置为 proxy = "no"。
# 
# 代理 URL 支持以下格式：
#   socks5://username:password@proxy_server_ip:port
#   socks5://username:password@proxy_server_domain:port
#   http://username:password@proxy_server_ip:port
#   https://username:password@proxy_server_domain:port
#
#proxy = "http://127.0.0.1:1080"
```

### `delivery` - 发送配置

本部分定义了与消息发送、代理和故障恢复相关的全局配置。

```toml
# 发送消息 配置段
[delivery]

# [可选] 全局代理
# 为所有通道的请求设置一个统一的代理服务器。
# 除非单个通道明确配置了不同的代理或设置为 "no"，否则所有通道都将默认使用此代理。
# 这在服务器需要通过特定的网络出口访问外部服务的场景下非常有用。
#
# 代理 URL 格式支持：
#   socks5://username:password@proxy_server_ip:port
#   socks5://username:password@proxy_server_domain:port
#   http://username:password@proxy_server_ip:port
#   https://username:password@proxy_server_domain:port
#
#proxy = "http://127.0.0.1:1080"

# [可选] 失败重试
# 配置一个健壮的重试机制，以应对网络波动或目标服务临时不可用等瞬时故障。
# 瞬时故障是指那些短暂且可能自行恢复的错误，例如网络抖动、临时服务器过载（HTTP 503）或网关超时（HTTP 504）。 
# 采用先进的重试策略（如指数退避和抖动）可以显著提高消息投递的成功率和系统的整体可靠性。
[delivery.retry]

# [可选] 重试次数
# 定义在放弃之前，对失败的请求尝试重新发送的最大次数。
# 设置为 0 表示禁用重试功能。
# 建议设置一个合理的重试上限（如 3 到 5 次），以避免在永久性故障（如配置错误或服务已下线）的情况下无限重试。
count = 5

# [可选] 基础间隔时间（单位：秒）
# 这是计算重试延迟的基础值。在固定间隔重试中，它就是每次的等待时间。
# 在指数退避算法中，它将作为计算的初始值。
# 最大值被限制在 900 秒（15分钟）以内。
interval = 10

# [可选] 指数退避算法 (Exponential Backoff)
# 定义重试间隔时间的增长方式。这是一种高级策略，每次重试的等待时间会逐渐变长。
# 它可以给下游服务更充分的恢复时间，有效避免因过于频繁的重试而压垮正在恢复的服务。
# `algorithm` 的值作为指数的底数。例如，设置为 2 时，后续的重试间隔会按 `interval * (2^n)` 的规律增长（n为重试次数）。
# 如果未配置此项或设置为 1，将使用固定的间隔时间 `interval`。
algorithm = 2

# [可选] 抖动 (Jitter)
# 在计算出的退避时间上增加一个随机的微小时间变化。
# 当有大量客户端同时失败并开始重试时，抖动可以打乱它们的重试节奏，
# 避免它们在完全相同的时间点同时发起请求，从而有效防止“惊群效应”(Thundering Herd Problem)。
# 启用后，实际的等待时间将在一个小的随机范围内波动，而不是一个固定的值。
jitter = true
```

#### 关键概念与策略详解

* **固定间隔重试 (Fixed Interval):**
    * **配置:** 未设置 `algorithm` 或 `algorithm = 1`。
    * **行为:** 每次重试都等待相同的 `interval` 时间。
    * **示例 (`interval = 10`):** 第一次重试等待 10 秒，第二次等待 10 秒，第三次仍然等待 10 秒。

* **指数退避 (Exponential Backoff):**
    * **配置:** `algorithm = 2` 。
    * **行为:** 重试的等待时间会以指数形式快速增加，给下游服务更长的恢复窗口。这在处理服务过载等问题时尤其有效。
    * **计算公式 (不含抖动):** `等待时间 = interval * (algorithm ^ (当前重试次数 - 1))`
    * **示例 (`interval = 10`, `algorithm = 2`):**
        * 第 1 次重试等待: `10 * (2^0)` = 10 秒
        * 第 2 次重试等待: `10 * (2^1)` = 20 秒
        * 第 3 次重试等待: `10 * (2^2)` = 40 秒

* **指数退避 + 抖动 (Exponential Backoff with Jitter):**
    * **配置:** `algorithm = 2`, `jitter = true`。
    * **行为:** 这是**最推荐**的重试策略。它结合了指数退避的优点，并通过增加随机性来避免流量洪峰，从而最大限度地提高系统的弹性和稳定性。
    * **计算方式:** 在指数退避计算出的等待时间基础上，增加一个随机的、较小的时间偏移。
    * **示例 (`interval = 10`, `algorithm = 2`, `jitter = true`):**
        * 第 1 次重试等待: 约 10 秒 (例如，可能是 9.8s 或 10.3s)
        * 第 2 次重试等待: 约 20 秒 (例如，可能是 19.5s 或 20.8s)
        * 第 3 次重试等待: 约 40 秒 (例如，可能是 39.2s 或 41.1s)

### `log` - 日志配置

本部分定义了应用程序的日志记录行为，这对于系统监控、问题排查和调试至关重要。通过调整这些参数，你可以控制日志的输出位置和详细程度。

```toml
# 日志配置
[log]

# [可选] 控制台输出
# 决定是否将日志实时打印到标准输出（例如，你的终端屏幕）。
# 在开发环境或使用 Docker/Kubernetes 等容器化环境时，将此项设置为 `true` 非常有用，
# 因为可以方便地通过 `docker logs` 或 `kubectl logs` 等命令直接查看日志流。
console = true

# [可选] 文件输出
# 决定是否将日志写入到持久化文件中。日志文件通常保存在程序根目录下的 'log' 文件夹中。
# 在生产环境中，强烈建议将此项设置为 `true`，以便于对历史事件进行审计和事后分析。
# 开启后，系统会自动处理日志文件的创建和轮转。
# 默认值: false
file = true

# [可选] 日志级别
# 设置日志记录的最低阈值。只有严重性等于或高于此级别的日志才会被记录。
# 合理地设置日志级别可以在不同环境中（如开发、测试、生产）捕获到适量的诊断信息，避免信息过载或信息不足。
# 可用级别（按详细程度从高到低排序）：
#   - "debug": 用于详细的故障排查，记录程序内部状态、变量值等。此级别可能产生大量日志，通常仅在开发和调试时开启。
#   - "info":  记录常规的、重要的业务流程事件，如服务启动、配置加载、请求处理等。这是推荐的生产环境默认级别。 
#   - "warn":  记录潜在的问题或非关键性错误，这些事件不影响当前流程，但需要引起注意，例如配置即将过期。
#   - "error": 记录导致部分功能失败的严重错误。这些问题需要立即关注。
# 默认值: "info"
level = "info"
```

### `api` - API 服务配置

本部分定义了应用程序内置 API 服务的网络监听参数。这些设置决定了 API 服务的可访问性及监听端口。

通过此 API，外部系统或用户可以与应用程序进行编程交互。

```toml
# api 配置
[api]

# [可选] 监听地址 (Host)
# 此参数决定了 API 服务绑定到哪个网络接口，从而控制其可访问范围。
# - host = "localhost": 服务将只在本地回环地址 (127.0.0.1) 上监听。
#                       这意味着 API 只能从运行应用程序的同一台机器内部进行访问。
#                       这是最安全的默认设置，可以有效防止服务被意外暴露到外部网络。
# - host = ""         : 服务将监听在所有可用的网络接口上 (通常表示为 0.0.0.0)。
#                       这使得 API 可以通过服务器的任何 IP 地址进行访问，包括局域网 IP 和公网 IP。
#                       当你需要从其他计算机或服务远程调用此 API 时，应使用此配置。
#
# 如果未配置，默认为 host = ""
#
host = "localhost"

# [可选] 监听端口 (Port)
# 指定 API 服务监听传入连接的 TCP 端口号。
# 确保所选端口未被该服务器上的其他任何应用程序占用。
# 端口 0-1023 通常是为系统服务保留的，建议使用 1024 以上的非特权端口。
#
# 默认值: 39270
port = 39270
```

#### 关键概念与安全实践

* **绑定地址 (Binding Address):**
    * `localhost` (或 `127.0.0.1`) 是一个特殊的地址，它始终指向“本机”。绑定到此地址的服务与外界网络隔离，安全性最高。
    * `0.0.0.0` 是一个通配地址，它告诉操作系统监听来自任何网络接口的连接请求。这是使服务能够被网络中其他设备访问的标准做法。

* **安全警告:**
  当设置 `host = ""` 以允许外部访问时，**必须**考虑安全问题，你将服务的入口暴露给了更广阔的网络环境。请务必确保：
    1. **防火墙规则：** 在服务器的防火墙上设置严格的访问规则，仅允许来自可信 IP 地址或网络的流量访问此端口。
    2. **网络隔离：** 如果可能，将服务部署在受信任的私有网络（如 VPC）中，而不是直接暴露在公共互联网上。
    3. **认证与授权：** 确保 API 本身具备强大的认证和授权机制，以防止未经授权的访问和操作。

## `PostPoint`调用频率限制

### 免费版，Free

固定的机器人发送消息速率。

1. api 接口：5 次/秒；
2. 发送消息：1 次/秒，9 次/分钟；

### 专业版，Pro

可配置的机器人发送消息速率，不能超过官网或最高速率限制。

1. api 接口：10 次/秒；
2. 企业微信群机器人，默认：1 次/秒，18 次/分钟。官网：每个机器人发送的消息不能超过20条/分钟。
3. 飞书自定义机器人，默认：4 次/秒，98 次/分钟。官网：自定义机器人的频率控制为 100 次/分钟，5 次/秒。
4. 钉钉自定义机器人，默认：1 次/秒，18 次/分钟。官网：每个机器人每分钟最多发送20条消息到群里，如果超过20条，会限流10分钟。
5. Slack 机器人，默认：1 次/秒。官网：1 次/秒。
6. Webhook，默认：1 次/秒。最高速率：5 次/秒。